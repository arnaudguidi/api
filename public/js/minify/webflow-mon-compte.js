<script>const updateHitorique=firebase.functions().httpsCallable("updateHitorique");var userData={},formulesData={},maxTry=0;const simulField=document.querySelector("#nbsimulations"),simulFieldIllimite=document.querySelector("#nbsimulations-illimite"),simulFieldPromo=document.querySelector("#nbsimulations-promo"),updateButton=document.querySelector("#updatebutton"),simulOk=document.querySelector("#simul-ok"),simulIllim=document.querySelector("#simul-illim"),navSimul=document.querySelector("#navsimul"),btnSimul=document.querySelector("#btn-simul-go"),nomField=document.querySelector("#nom"),prenomlField=document.querySelector("#prenom"),entrepriseField=document.querySelector("#entreprise"),telField=document.querySelector("#tel"),siretField=document.querySelector("#siret"),tvaField=document.querySelector("#tva"),uploadField=document.querySelector("#upload"),emailField=document.querySelector("#email"),passwordField=document.querySelector("#mot-de-passe"),formuleNom=document.querySelector("#formuleNom"),formuleNbSimul=document.querySelector("#formuleNbSimul"),formulePrix=document.querySelector("#formulePrix"),formuleNone=document.querySelector("#formule-none"),formuleBlocPrix=document.querySelector("#formule-bloc-prix"),historiqueContainer=document.querySelector("#historique-container"),historiqueBloc=document.querySelector("#historique-liste");historiqueContainer.style.display="none";const warning=document.querySelector("#warningprofil");warning.style.display="none";const errorField=document.querySelector("#errorMessage"),inputNom=document.querySelector("#nom");inputNom.setAttribute("onchange","inputChange()");const inputPrenom=document.querySelector("#prenom");inputPrenom.setAttribute("onchange","inputChange()");const inputEntreprise=document.querySelector("#entreprise");inputEntreprise.setAttribute("onchange","inputChange()");const inputTel=document.querySelector("#tel");inputTel.setAttribute("onchange","inputChange()");const inputSiret=document.querySelector("#siret");inputSiret.setAttribute("onchange","inputChange()");const inputTva=document.querySelector("#tva");inputTva.setAttribute("onchange","inputChange()");const inputLogo=document.querySelector("#fileToUpload");inputLogo.setAttribute("onchange","inputChange(1)");const btnAbonnement=document.querySelector("#btnabonnement");btnAbonnement.style.display="none";const imglogo=document.querySelector("#imglogo");var logo_b64="";const contentToHide=document.querySelector(".page-contents"),loader=document.querySelector(".loader"),loaderStart=()=>{contentToHide.style.opacity="0",loader.style.opacity="1"},loaderStop=()=>{contentToHide.style.opacity="1",loader.style.opacity="0"};var initDone=!1;const initMoncompte=()=>{console.log("**** initMoncompte ****"),emailField.disabled=!0,passwordField.disabled=!0,formuleNone.style.display="none",simulIllim.style.display="none",navSimul.style.display="none",formuleBlocPrix.style.display="none",errorField.innerHTML="",updateButton.classList.add("disabled"),updateButton.setAttribute("disabled",""),initDone=!0,findGeneralSettings()},findGeneralSettings=()=>{var formdocRef;console.log("***** findGeneralSettings ****"),db.collection("settings").doc("settings_doc").get().then(doc=>{doc.exists?(formulesData=doc.data(),console.log("formulesData : ",formulesData),findUserData()):console.log("No such document!")}).catch(error=>{console.log("Error getting document:",error)})},findUserData=()=>{var docRef;console.log("***** findUserData ****"),db.collection("users").doc(currentUserUID).get().then(doc=>{doc.exists?(userData=doc.data(),console.log("userData : ",userData),formulesUpdate()):(console.log("No such document!"),(maxTry+=1)<10&&setTimeout("findUserData()",500))}).catch(error=>{console.log("Error getting document:",error)})},writeIfExists=(valeur,cible)=>{valeur&&""!=valeur&&(cible.value=valeur)},fillUserData=()=>(console.log("**** fillUserData ****"),writeIfExists(userData.nom,nomField),writeIfExists(userData.prenom,prenomlField),writeIfExists(userData.entreprise,entrepriseField),writeIfExists(userData.tel,telField),writeIfExists(userData.siret,siretField),writeIfExists(userData.tva,tvaField),writeIfExists(userData.email,emailField),""!=userData.logo_url&&(imglogo.src=userData.logo_url),userData.nom&&userData.prenom&&userData.entreprise&&userData.siret&&userData.tva||(console.log("Un des champs requis est manquant"),warning.style.display="block"),null),simulsUpdate=()=>{console.log("**** simulsUpdate ****");var simulPromoValue=userData.nb_simul_start,simulValue=userData.nb_simul_left,totalSimul=null;-1!==simulValue&&(totalSimul=simulPromoValue+simulValue),-1===simulValue&&(totalSimul=simulPromoValue),console.log("Nombre de simulations promotionnelles restantes : ",simulPromoValue),console.log("Nombre de simulations restantes : ",simulValue),console.log("Nombre total de simulations : ",totalSimul);var DontTantGratuites="",simulMot="";simulPromoValue>0&&(simulOk.style.display="block",navSimul.style.display="block",simulPromoValue>1&&(simulMot=" simulations",DontTantGratuites=" dont "+simulPromoValue+" gratuites"),1==simulPromoValue&&(simulPromoValue="",simulMot=" simulation",DontTantGratuites=" dont 1 gratuite"),console.log("Il reste des simulations promotionnelles ",simulPromoValue)),0===simulValue&&(console.log("Il n'y a aucune simulation restante ",simulValue),simulMot=" simulation"),-1===simulValue&&(navSimul.style.display="block",simulIllim.style.display="block",simulOk.style.display="none",console.log("Nombre de simulations illimitÃ© ",simulValue)),simulValue>=1&&(simulOk.style.display="block",navSimul.style.display="block",simulValue>1&&(simulMot=" simulations"),1==simulValue&&(simulValue="",simulMot=" simulation"),console.log("Il reste 1 ou plusieurs simulations payantes ",simulValue)),totalSimul>0&&(simulMot=" simulations"),simulField.innerHTML=totalSimul+simulMot+DontTantGratuites,0===simulValue&&0===simulPromoValue&&(console.log("Il ne reste aucune simul en promo ou payante"),btnSimul.style.display="none",simulField.innerHTML="Vous n'avez plus de simulation"),historiqueGet(),fillUserData()},formulesUpdate=()=>{console.log("**** formulesUpdate ****");var formuleValue=userData.formule;console.log("Type de formule : ",formuleValue),0===formuleValue?(console.log("Gratuit Promo",formuleValue),formuleNone.style.display="block",formuleBlocPrix.style.display="none"):1===formuleValue?(console.log("Payant 1",formuleValue," - ",formulesData.formule1.Nom),formuleNone.style.display="none",formuleBlocPrix.style.display="block",formuleNom.innerHTML=formulesData.formule1.Nom,formuleNbSimul.innerHTML=formulesData.formule1.Texte_simul,formulePrix.innerHTML=formulesData.formule1.Prix):2===formuleValue?(console.log("Payant 2",formuleValue," - ",formulesData.formule2.Nom),formuleNone.style.display="none",formuleBlocPrix.style.display="block",formuleNom.innerHTML=formulesData.formule2.Nom,formuleNbSimul.innerHTML=formulesData.formule2.Texte_simul,formulePrix.innerHTML=formulesData.formule2.Prix):3===formuleValue?(console.log("Payant 3",formuleValue," - ",formulesData.formule3.Nom),formuleNone.style.display="none",formuleBlocPrix.style.display="block",formuleNom.innerHTML=formulesData.formule3.Nom,formuleNbSimul.innerHTML=formulesData.formule3.Texte_simul,formulePrix.innerHTML=formulesData.formule3.Prix):4===formuleValue&&(console.log("Payant 4",formuleValue," - ",formulesData.formule4.Nom),formuleNone.style.display="none",formuleBlocPrix.style.display="block",formuleNom.innerHTML=formulesData.formule4.Nom,formuleNbSimul.innerHTML=formulesData.formule4.Texte_simul,formulePrix.innerHTML=formulesData.formule4.Prix,btnAbonnement.style.display="flex"),simulsUpdate()};function inputChange(imgSelect){if(console.log("** inputchange"),1===imgSelect){var selectedFile=inputLogo.files[0],reader=new FileReader;reader.onloadend=function(){imglogo.src=reader.result},selectedFile?(reader.readAsDataURL(selectedFile),selectedFile.convertToBase64((function(base64){logo_b64=base64}))):imglogo.src=""}updateButton.removeAttribute("disabled"),updateButton.classList.remove("disabled")}File.prototype.convertToBase64=function(callback){var reader=new FileReader;reader.onloadend=function(e){callback(e.target.result,e.target.error)},reader.readAsDataURL(this)},updateButton.addEventListener("click",e=>{e.preventDefault(),updateUserInformations()});const sendToCustomerPortal=async()=>{const functionRef=firebase.app().functions("europe-west1").httpsCallable("ext-firestore-stripe-subscriptions-createPortalLink"),{data:data}=await functionRef({returnUrl:window.location.origin});window.location.assign(data.url)};btnAbonnement.addEventListener("click",e=>{e.preventDefault(),contentToHide.style.opacity="0",loader.style.opacity="1",sendToCustomerPortal()});
</script>